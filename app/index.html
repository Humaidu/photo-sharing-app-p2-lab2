<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Photo Sharing App</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1>Upload an Image</h1>
    <input type="file" id="uploadFile" />
    <button onclick="uploadImage()">Upload</button>

    <h2>Gallery</h2>
    <div id="gallery"></div>

    <script>
      // Upload image to your S3 bucket directly (assumes public bucket and correct CORS)
      async function uploadImage() {
        const fileInput = document.getElementById("uploadFile");
        const file = fileInput.files[0];

        if (!file) return alert("Please choose a file.");

        const fileName = encodeURIComponent(file.name);

        // 1. Get presigned upload URL
        const res = await fetch(
          `https://qm4m50t397.execute-api.eu-west-1.amazonaws.com/prod/getUploadedUrl?filename=${fileName}`
        );
        const data = await res.json();
        const uploadUrl = data.uploadUrl;

        // 2. Upload file directly to S3
        const upload = await fetch(uploadUrl, {
          method: "PUT",
          headers: {
            "Content-Type": "image/jpeg",
          },
          body: file,
        });

        if (upload.ok) {
          setTimeout(() => {
            displayImages(); // Refresh the image gallery
          }, 2000); // Adjust delay if needed
          alert("Upload successful!");
        } else {
          alert("Upload failed.");
        }
      }

      // Asynchronous function to Fetch thumbnail URLs from the Lambda-backed API
      async function displayImages() {
        // Get the gallery container element
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = ""; // Clear gallery

        try {
          // Make a GET request to the API Gateway endpoint to fetch thumbnail image URLs
          const response = await fetch(
            "https://qm4m50t397.execute-api.eu-west-1.amazonaws.com/prod/getThumbnailImages"
          );
          
          // If the response is not OK (i.e., not status 200), throw an error
          if (!response.ok) {
            throw new Error("Failed to fetch images.");
          }
          
          // Parse the JSON response body to get the list of image URLs
          const imageUrls = await response.json();
          
          // If there are no images, display a placeholder message
          if (imageUrls.length === 0) {
            gallery.innerHTML = "<p>No images yet.</p>";
            return;
          }
          
          // Loop through the image URLs and create image elements for each
          imageUrls.forEach((url) => {
            const img = document.createElement("img");
            img.src = url;
            img.alt = "Thumbnail";
            img.width = 150;
            img.height = 150;
            img.style.margin = "10px";
            img.style.borderRadius = "8px";
            img.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
            gallery.appendChild(img); // Append the image to the gallery
          });
        } catch (error) {
          // Log and display an error message if the fetch fails
          console.error("Error fetching images:", error);
          gallery.innerHTML = "<p>Error loading images.</p>";
        }
      }

      // Load images when the page loads
      window.onload = displayImages;
    </script>
  </body>
</html>
